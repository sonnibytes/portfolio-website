<!-- 
  *blog/templates/blog/admin/tag_list.html
  *Version 3.0
  -->
{% extends 'admin/admin_base.html' %}
{% load static %}
{% load aura_filters %}

{% block admin_title %}DataLog Tags{% endblock %}

{% block admin_css %}
<style>
  .tag-cloud-section {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .tag-bubble {
    display: inline-flex;
    align-items: center;
    background: rgba(179, 157, 219, 0.1);
    border: 1px solid rgba(179, 157, 219, 0.3);
    border-radius: 24px;
    padding: 0.5rem 1rem;
    margin: 0.25rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .tag-bubble:hover {
    background: rgba(179, 157, 219, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(179, 157, 219, 0.3);
  }
  
  .tag-name {
    color: #b39ddb;
    font-weight: 500;
    margin-right: 0.5rem;
  }
  
  .tag-count {
    background: rgba(179, 157, 219, 0.3);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 0.5rem;
  }
  
  .tag-actions {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .tag-bubble:hover .tag-actions {
    opacity: 1;
  }
  
  .tag-action {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 0.75rem;
    transition: all 0.2s ease;
  }
  
  .tag-action.edit {
    background: rgba(38, 198, 218, 0.2);
    color: #26c6da;
  }
  
  .tag-action.view {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
  }
  
  .tag-action:hover {
    transform: scale(1.1);
  }
  
  .admin-table {
    width: 100%;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .admin-table thead {
    background: rgba(179, 157, 219, 0.1);
  }
  
  .admin-table th {
    padding: 1rem;
    text-align: left;
    color: #b39ddb;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .admin-table-row {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
  }
  
  .admin-table-row:hover {
    background: rgba(179, 157, 219, 0.05);
  }
  
  .admin-table td {
    padding: 1rem;
    color: #e8eaf6;
    vertical-align: middle;
  }
  
  .tag-usage-bar {
    width: 100px;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
  }
  
  .tag-usage-fill {
    height: 100%;
    background: linear-gradient(90deg, #b39ddb, #26c6da);
    border-radius: 3px;
    transition: width 0.3s ease;
  }
  
  .tag-filter-bar {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .filter-group {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
  }
  
  .filter-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .filter-label {
    font-size: 0.875rem;
    color: #e8eaf6;
    font-weight: 500;
  }
  
  .filter-input {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.5rem 1rem;
    color: white;
    min-width: 120px;
  }
  
  .filter-input:focus {
    outline: none;
    border-color: #b39ddb;
    box-shadow: 0 0 0 2px rgba(179, 157, 219, 0.2);
  }
  
  .recent-posts-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .recent-post-link {
    color: #26c6da;
    text-decoration: none;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    transition: all 0.2s ease;
  }
  
  .recent-post-link:hover {
    background: rgba(38, 198, 218, 0.1);
    color: #26c6da;
  }
  
  @media (max-width: 768px) {
    .filter-group {
      flex-direction: column;
      align-items: stretch;
    }
    
    .admin-table {
      font-size: 0.875rem;
    }
    
    .admin-table td,
    .admin-table th {
      padding: 0.75rem 0.5rem;
    }
    
    .tag-cloud-section {
      padding: 1rem;
    }
  }
</style>
{% endblock %}

{% block admin_content %}
<div class="space-y-6">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
      <h1 class="text-2xl font-bold text-white mb-2">
        <i class="fas fa-tags text-violet-400 mr-2"></i>
        DataLog Tags Management
            </h1>
      <p class="text-gray-400">Organize and manage tags for better DataLog discoverability</p>
        </div>
    <div class="mt-4 sm:mt-0">
        <a href="{% url 'aura_admin:blog:tag_create' %}" 
         class="inline-flex items-center px-4 py-2 bg-lavender-500 hover:bg-lavender-400 text-black font-medium rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-lavender-500/25">
            <i class="fas fa-plus mr-2"></i>
            Add Tag
        </a>
    </div>
    </div>

  <!-- Stats Summary -->
  <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
    <div class="glass-card p-4 text-center">
      <div class="text-2xl font-bold text-rose-400 mb-1">{{ tags.count }}</div>
            <div class="text-sm text-gray-400">Total Tags</div>
    </div>
    <div class="glass-card p-4 text-center">
      <div class="text-2xl font-bold text-blue-400 mb-1">
        {{ total_tag_usage|default:0 }}
      </div>
      <div class="text-sm text-gray-400">Total Tag Usage</div>
    </div>
    <div class="glass-card p-4 text-center">
      <div class="text-2xl font-bold text-green-400 mb-1">
        {{ popular_tags_count|default:0 }}
      </div>
      <div class="text-sm text-gray-400">Popular Tags (5+ uses)</div>
    </div>
    <div class="glass-card p-4 text-center">
      <div class="text-2xl font-bold text-purple-400 mb-1">
        {{ avg_tags_per_post|floatformat:1|default:0 }}
      </div>
      <div class="text-sm text-gray-400">Avg Tags/Post</div>
    </div>

    <!-- New: Source Type Stats -->
    <div class="glass-card p-4 text-center">
      <div class="text-2xl font-bold text-teal-400 mb-1">
        {{ skill_tags_count }}
      </div>
      <div class="text-sm text-gray-400">
        <i class="fas fa-brain mr-1"></i>Skills
      </div>
    </div>
    <div class="glass-card p-4 text-center">
      <div class="text-2xl font-bold text-amber-400 mb-1">
        {{ tech_tags_count }}
      </div>
      <div class="text-sm text-gray-400">
        <i class="fas fa-code mr-1"></i>Tech
      </div>
    </div>
    <div class="glass-card p-4 text-center">
      <div class="text-2xl font-bold text-fuchsia-400 mb-1">
        {{ manual_tags_count }}
      </div>
      <div class="text-sm text-gray-400">
        <i class="fas fa-pen mr-1"></i>Manual
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="tag-filter-bar">
    <form method="GET" class="filter-form" id="tagFilterForm">
      <div class="filter-group">
        <div class="filter-item">
          <label class="filter-label">Search Tags</label>
          <input type="text" name="search" value="{{ request.GET.search }}" 
                 placeholder="Search by tag name..." class="filter-input">
          </div>
        
        <div class="filter-item">
          <label class="filter-label">Usage Filter</label>
          <select name="usage" class="filter-input">
            <option value="">All Tags</option>
            <option value="popular" {% if request.GET.usage == 'popular' %}selected{% endif %}>Popular (5+ uses)</option>
            <option value="moderate" {% if request.GET.usage == 'moderate' %}selected{% endif %}>Moderate (2-4 uses)</option>
            <option value="rare" {% if request.GET.usage == 'rare' %}selected{% endif %}>Rare (1 use)</option>
            <option value="unused" {% if request.GET.usage == 'unused' %}selected{% endif %}>Unused</option>
          </select>
        </div>

        <!-- NEW: Source filter -->
        <div class="filter-item">
          <label class="filter-label">Source Type</label>
          <select name="source" class="filter-input" onchange="this.form.submit()">
            <option value="">All Sources</option>
            <option value="skill" {% if request.GET.source == 'skill' %}selected{% endif %}>
              <i class="fas fa-brain"></i> Skills
            </option>
            <option value="technology" {% if request.GET.source == 'technology' %}selected{% endif %}>
              <i class="fas fa-code"></i> Technologies
            </option>
            <option value="manual" {% if request.GET.source == 'manual' %}selected{% endif %}>
              <i class="fas fa-pen"></i> Manual
            </option>
          </select>
        </div>
        
        <div class="filter-item">
          <label class="filter-label">Sort By</label>
          <select name="sort" class="filter-input">
            <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>Name A-Z</option>
            <option value="-name" {% if request.GET.sort == '-name' %}selected{% endif %}>Name Z-A</option>
            <option value="post_count" {% if request.GET.sort == 'post_count' %}selected{% endif %}>Usage (Low to High)</option>
            <option value="-post_count" {% if request.GET.sort == '-post_count' %}selected{% endif %}>Usage (High to Low)</option>
            <option value="-created" {% if request.GET.sort == '-created' %}selected{% endif %}>Recently Created</option>
          </select>
          </div>
        
        <div class="filter-item">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-search mr-2"></i>Filter
          </button>
          <a href="{% url 'aura_admin:blog:tag_list' %}" class="btn btn-secondary">
            <i class="fas fa-times mr-2"></i>Clear
            </a>
        </div>
      </div>
    </form>
  </div>
      
  <!-- Popular Tags Cloud -->
  {% if popular_tags %}
    <div class="tag-cloud-section">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-white flex items-center">
            <i class="fas fa-fire mr-2 text-orange-400"></i>
            Most Popular Tags
          </h3>
        <span class="text-sm text-gray-400">Showing top {{ popular_tags|length }} tags</span>
      </div>
          <div class="flex flex-wrap gap-3">
            {% for tag in popular_tags %}
        <div class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium 
                    {% if tag.source_skill %}
                      bg-teal-500 bg-opacity-20 text-teal-400 border border-teal-400 border-opacity-30
                    {% elif tag.source_tech %}
                      bg-blue-500 bg-opacity-20 text-blue-400 border border-blue-400 border-opacity-30
                    {% else %}
                      bg-purple-400 bg-opacity-20 text-purple-400 border border-purple-400 border-opacity-30
                    {% endif %}">
          <i class="{{ tag.source_icon }} mr-1.5" style="font-size: 0.75rem;"></i>
          <span class="tag-name">#{{ tag.name }}</span>
          <span class="ml-2 text-xs opacity-75">({{ tag.post_count }})</span>
        </div>
      {% endfor %}
        {% comment %} {% for tag in popular_tags %}
          <div class="tag-bubble" style="font-size: {{ tag.font_size|default:'1' }}rem;">
            <span class="tag-name">#{{ tag.name }}</span>
                <span class="tag-count">{{ tag.post_count }}</span>
                <div class="tag-actions">
              <a href="{% url 'aura_admin:blog:tag_edit' tag.pk %}" class="tag-action edit" title="Edit">
                    <i class="fas fa-edit"></i>
                  </a>
              <a href="{% url 'aura_admin:blog:post_list' %}?search={{ tag.name }}" class="tag-action view" title="View Posts">
                    <i class="fas fa-eye"></i>
                  </a>
                </div>
              </div>
            {% endfor %} {% endcomment %}
          </div>
        </div>
      {% endif %}

      <!-- All Tags Table -->
      <div class="glass-card overflow-hidden">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Tag</th>
              <th>Source</th>
              <th>Usage</th>
              <th>Recent DataLogs</th>
              <th>First Used</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for tag in tags %}
              <tr class="admin-table-row">
                <td>
                  <div class="flex items-center">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                            {% if tag.source_type == 'skill' %}
                              bg-teal-500 bg-opacity-20 text-teal-400 border border-teal-400 border-opacity-30
                            {% elif tag.source_type == 'technology' %}
                              bg-blue-500 bg-opacity-20 text-blue-400 border border-blue-400 border-opacity-30
                            {% else %}
                              bg-purple-400 bg-opacity-20 text-purple-400 border border-purple-400 border-opacity-30
                            {% endif %} mr-3">
                  #{{ tag.name }}
                </span>
                    {% comment %} <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-400 bg-opacity-20 text-purple-400 border border-purple-400 border-opacity-30 mr-3">
                      #{{ tag.name }}
                    </span> {% endcomment %}
                    <div>
                      {% comment %} <div class="text-white font-medium">{{ tag.name }}</div> {% endcomment %}
                      {% if tag.slug != tag.name %}
                        <div class="text-xs text-gray-400">{{ tag.slug }}</div>
                      {% endif %}
                    </div>
                  </div>
                </td>

                <!-- New: Source Type Column -->
            <td>
              <div class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium
                          {% if tag.source_type == 'skill' %}
                            bg-teal-500 bg-opacity-10 text-teal-400
                          {% elif tag.source_type == 'technology' %}
                            bg-blue-500 bg-opacity-10 text-blue-400
                          {% else %}
                            bg-purple-500 bg-opacity-10 text-purple-400
                          {% endif %}">
                <i class="{{ tag.source_icon|safe_icon }} mr-1.5"></i>
                {{ tag.source_label }}
              </div>
              {% if tag.source_skill %}
                <div class="text-xs text-gray-500 mt-1">
                  {{ tag.source_skill.get_category_display }}
                </div>
              {% elif tag.source_tech %}
                <div class="text-xs text-gray-500 mt-1">
                  {{ tag.source_tech.get_category_display }}
                </div>
              {% endif %}
            </td>

                <td>
                  <div class="flex items-center">
                    <span class="text-lg font-bold text-white mr-2">{{ tag.post_count }}</span>
                <div class="flex flex-col">
                    <span class="text-sm text-gray-400">
                    {{ tag.post_count }} DataLog{{ tag.post_count|pluralize }} - {{ tag.usage_percentage|floatformat:0|default:0}}%
                    </span>
                    {% if tag.post_count == 0 %}
                      <span class="text-xs text-orange-400 mt-1">
                        <i class="fas fa-exclamation-triangle mr-1"></i>Unused
                      </span>
                    {% endif %}
                  <div class="tag-usage-bar">
                    <div class="tag-usage-fill" 
                         style="width: {{ tag.usage_percentage|default:0 }}%;"></div>
                  </div>
                </div>
                    </div>
            </td>
            <td>
              {% if tag.recent_posts %}
                <div class="recent-posts-list">
                  {% for post in tag.recent_posts|slice:":3" %}
                    <a href="{% url 'aura_admin:blog:post_edit' post.pk %}" 
                       class="recent-post-link">
                      {{ post.title|truncatechars:40 }}
                    </a>
                  {% endfor %}
                  {% if tag.post_count > 3 %}
                    <span class="text-xs text-gray-500">
                      +{{ tag.post_count|add:"-3" }} more
                    </span>
                  {% endif %}
                    </div>
                  {% else %}
                <span class="text-gray-500 text-sm">No posts yet</span>
                  {% endif %}
                </td>
                <td>
              <div class="text-sm text-gray-400">
                {{ tag.first_used|date:"M d, Y" }}
                <br>
                <span class="text-xs">{{ tag.first_used|timesince }} ago</span>
                  </div>
                </td>
                <td>
                  <div class="flex items-center space-x-2">
                    <a href="{% url 'aura_admin:blog:tag_edit' tag.pk %}" 
                   class="inline-flex items-center px-2 py-1 bg-blue-500 bg-opacity-20 text-blue-400 rounded-lg hover:bg-opacity-30 transition-colors">
                  <i class="fas fa-edit mr-1"></i>
                  Edit
                </a>
                <a href="{% url 'aura_admin:blog:post_list' %}?search={{ tag.name }}" 
                   class="inline-flex items-center px-2 py-1 bg-green-500 bg-opacity-20 text-green-400 rounded-lg hover:bg-opacity-30 transition-colors">
                  <i class="fas fa-eye mr-1"></i>
                  Posts
                    </a>

                    <!-- Show link to source if exists -->
                {% comment %} {% if tag.source_skill %}
                  <a href="{% url 'core:skill_detail' tag.source_skill.slug %}" 
                     class="inline-flex items-center px-2 py-1 bg-teal-500 bg-opacity-20 text-teal-400 rounded-lg hover:bg-opacity-30 transition-colors"
                     title="View Skill">
                    <i class="fas fa-external-link-alt"></i>
                  </a> {% endcomment %}
                {% if tag.source_tech %}
                  <a href="{% url 'projects:technology_detail' tag.source_tech.slug %}" 
                     class="inline-flex items-center px-2 py-1 bg-blue-500 bg-opacity-20 text-blue-400 rounded-lg hover:bg-opacity-30 transition-colors"
                     title="View Technology">
                    <i class="fas fa-external-link-alt"></i>
                  </a>
                {% endif %}  

                    <a href="{% url 'aura_admin:blog:tag_delete' tag.pk %}" 
                   class="inline-flex items-center px-2 py-1 bg-red-500 bg-opacity-20 text-red-400 rounded-lg hover:bg-opacity-30 transition-colors"
                   onclick="return confirm('Are you sure you want to delete this tag?')">
                  <i class="fas fa-trash mr-1"></i>
                  Delete
                    </a>
                  </div>
                </td>
              </tr>
        {% empty %}
          <tr>
            <td colspan="5">
              <div class="text-center py-12">
                <div class="text-gray-400">
                  <i class="fas fa-tags text-6xl mb-4"></i>
                  <h3 class="text-xl font-bold mb-2">No Tags Found</h3>
                  <p class="text-sm mb-4">
                    {% if request.GET.search or request.GET.usage %}
                      No tags match your current filters.
                      <br>
                      <a href="{% url 'aura_admin:blog:tag_list' %}" class="text-violet-400 hover:text-violet-300">Clear filters</a>
                      to see all tags.
                    {% else %}
                      Start organizing your DataLogs by creating your first tag.
                    {% endif %}
                  </p>
                  <a href="{% url 'aura_admin:blog:tag_create' %}" 
                     class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>Add Your First Tag
                  </a>
                </div>
              </div>
            </td>
          </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {% if is_paginated %}
    <div class="flex items-center justify-between mt-8">
      <div class="text-sm text-gray-400">
        Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} tags
      </div>
      <div class="flex space-x-2">
          {% if page_obj.has_previous %}
          <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.usage %}&usage={{ request.GET.usage }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" 
             class="px-3 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors">
            First
          </a>
          <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.usage %}&usage={{ request.GET.usage }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" 
             class="px-3 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors">
            Previous
          </a>
          {% endif %}

        <span class="px-3 py-2 bg-lavender-500 text-black rounded-lg">
          {{ page_obj.number }}
          </span>

          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.usage %}&usage={{ request.GET.usage }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" 
             class="px-3 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors">
            Next
          </a>
          <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.usage %}&usage={{ request.GET.usage }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" 
             class="px-3 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors">
            Last
          </a>
        {% endif %}
      </div>
      </div>
    {% endif %}

  </div>

<script>
// Auto-submit filter form on select change
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('#tagFilterForm select');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            document.getElementById('tagFilterForm').submit();
        });
    });
    
    // Add search input debounce
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (this.value.length >= 2 || this.value.length === 0) {
                    document.getElementById('tagFilterForm').submit();
                }
            }, 500);
        });
    }
    
    
    // Animate usage bars on page load
    setTimeout(() => {
        document.querySelectorAll('.tag-usage-fill').forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 100);
        });
    }, 200);
});
</script>
{% endblock %}