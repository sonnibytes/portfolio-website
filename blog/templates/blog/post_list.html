<!----
 * AURA Portfolio - DataLogs List Template - UPDATED WITH UNIFIED SEARCH
 * Advanced User Repository & Archive - Now using unified search system
 * Version: 3.1.0 - Clean, organized search implementation
---->

{% extends "blog/datalogs_base.html" %}
{% load static %}
{% load aura_filters %}
{% load aura_components %}
{% load datalog_tags %}

{% block datalogs_title %}DataLogs Archive{% endblock %}

{% block datalogs_css %}
<!-- All styling now handled by consolidated CSS -->
{% endblock %}

{% block show_breadcrumbs %}False{% endblock %}
{% block show_filters %}True{% endblock %}

{% block datalogs_content %}

<!-- UNIFIED SEARCH INTERFACE (Replaces old search components) -->
<section class="datalogs-search-section">
    <div class="container">
        {% unified_search_interface query=query style='full' show_quick_filters=True enable_ajax=True show_stats=True %}
    </div>
</section>

<!-- Category Navigation using Phase 1 Component -->
<section class="categories-navigation-section">
    <div class="container">
        {% category_hexagon_nav style="full" current_category=current_category show_all=True limit=None %}
    </div>
</section>

<!-- Enhanced Featured DataLog Entry -->
{% if featured_post %}
<section class="featured-datalog-section">
    <div class="container">
        
        <!-- UNIFIED FEATURED CONTAINER -->
        <div class="featured-datalog-unified-container glass-effect">
            
            <!-- Featured Post Header -->
            <div class="featured-post-header">
                <div class="featured-badge">
                    <i class="fas fa-star"></i>
                    <span>Featured Entry</span>
                </div>
                
                <h2 class="featured-post-title">
                    <a href="{{ featured_post.get_absolute_url }}">{{ featured_post.title }}</a>
                </h2>
                
                <!-- Post ID and Status -->
                <div class="featured-post-status">
                    <span class="post-id">{{ featured_post.id|datalog_id }}</span>
                    {% if featured_post.category %}
                    <span class="post-category-badge" style="--category-color: {{ featured_post.category.color }};">
                        {% if featured_post.category.icon %}
                        <i class="fas {{ featured_post.category.icon }}"></i>
                        {% endif %}
                        {{ featured_post.category.code }}
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Main Featured Content Grid -->
            <div class="featured-content-grid">
                
                <!-- LEFT SIDE: Post Information -->
                <div class="featured-post-info">
                    
                    <!-- Excerpt/Description -->
                    {% if featured_post.excerpt %}
                    <div class="featured-excerpt">
                        <p>{{ featured_post.excerpt|truncate_smart:180 }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- System Connections (if available) -->
                    {% if featured_post.related_systems.exists %}
                    <div class="featured-systems-section">
                        <div class="systems-header">
                            <i class="fas fa-project-diagram"></i>
                            <span>Connected Systems</span>
                        </div>
                        {% include 'blog/includes/system_connections.html' with post=featured_post style='compact' max_systems=3 %}
                    </div>
                    {% endif %}
                    
                    <!-- Tags Section -->
                    {% if featured_post.tags.exists %}
                    <div class="featured-tags-section">
                        <div class="tags-header">
                            <i class="fas fa-tags"></i>
                            <span>Topics</span>
                        </div>
                        <div class="featured-tags-list">
                            {% for tag in featured_post.tags.all|slice:":5" %}
                            <a href="{% url 'blog:tag' slug=tag.slug %}" class="featured-tag">
                                #{{ tag.name }}
                            </a>
                            {% endfor %}
                            {% if featured_post.tags.count > 5 %}
                            <span class="more-tags">+{{ featured_post.tags.count|add:"-5" }} more</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Action Buttons -->
                    <div class="featured-actions">
                        <a href="{{ featured_post.get_absolute_url }}" class="btn btn-primary btn-featured">
                            <i class="fas fa-arrow-right"></i>
                            Read Full DataLog
                        </a>
                        
                        {% if featured_post.category %}
                        <a href="{% url 'blog:category' slug=featured_post.category.slug %}" class="btn btn-outline btn-category">
                            <i class="fas {{ featured_post.category.icon|default:'fas fa-folder' }}"></i>
                            Browse {{ featured_post.category.name }}
                        </a>
                        {% endif %}
                    </div>
                    
                </div>
                
                <!-- RIGHT SIDE: Terminal Display -->
                {% if featured_post.featured_code %}
                <div class="featured-terminal-section">
                    {% terminal_display post=featured_post style="enhanced" %}
                </div>
                {% endif %}
                
            </div>
            
            <!-- Featured Footer -->
            <div class="featured-post-footer">
                <div class="footer-stats">
                    <div class="stat-item">
                        <i class="fas fa-eye"></i>
                        <span>{{ featured_post.views.count|default:0|format_number }} views</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>{{ featured_post.published_date|time_since_published }}</span>
                    </div>
                    {% if featured_post.reading_time %}
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <span>{{ featured_post.reading_time|format_duration }} read</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="footer-actions">
                    <!-- Social sharing or other quick actions could go here -->
                    <button class="footer-action-btn" title="Bookmark">
                        <i class="fas fa-bookmark"></i>
                    </button>
                    <button class="footer-action-btn" title="Share">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
            </div>
            
        </div>
    </div>
</section>
{% endif %}

<!-- DataLog Entries using DATA GRID COMPONENT -->
<section class="datalogs-grid-section">
    <div class="container">
        
        <!-- Enhanced Header with Statistics -->
        {% section_header title="DataLog Entries" subtitle="Technical Documentation Archive" icon="fas fa-database" show_metrics=True metric_1_value=page_obj.paginator.count|default:posts|length metric_1_label="Total Entries" metric_1_icon="fas fa-file-alt" metric_2_value=current_category.name|default:"All Categories" metric_2_label="Category" metric_2_icon="fas fa-folder" metric_3_value=posts|length metric_3_label="Showing" metric_3_icon="fas fa-eye" animated=True %}
        
        <!-- Data Grid for Posts -->
        {% include 'components/data_grid.html' with items=posts grid_type="datalogs" columns=3 show_controls=True show_sort=True show_filters=True allow_compact=True view_mode="grid" count_label="DataLog entries" %}
        
    </div>
</section>

<!-- Enhanced Pagination -->
{% if is_paginated %}
<section class="pagination-section">
    <div class="container">
        {% render_pagination page_obj request %}
    </div>
</section>
{% endif %}

<!-- Filter Panel (NEW COMPONENT) - Handled by datalogs_base.html but enhanced -->
<!-- The filter panel is automatically included via datalogs_base.html show_filters=True -->
<!-- Enhanced with our new datalog_filters_panel component -->

{% endblock %}

{% block datalogs_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ” Initializing unified search system...');
    
    if (window.datalogInterface) {
        // Configure the unified search
        window.datalogInterface.unifiedSearch = {
            endpoint: '{% url "blog:search_ajax" %}',
            debounceDelay: 300,
            minQueryLength: 2,
            maxSuggestions: 6,
            enableKeyboardNav: true,
            enableAjax: true,
            currentQuery: '{{ query|default:"" }}',
            
            // Initialize the unified search system
            init: function() {
                const searchInput = document.getElementById('unifiedSearchInput');
                const suggestionsDropdown = document.getElementById('searchSuggestionsDropdown');
                const suggestionsContent = document.getElementById('suggestionsContent');
                const clearBtn = document.getElementById('searchClearBtn');
                
                if (!searchInput) return;
                
                console.log('âœ… Found search input, setting up unified search...');
                
                // Initialize components
                this.setupSearchInput(searchInput, suggestionsDropdown, suggestionsContent);
                this.setupClearButton(searchInput, clearBtn);
                this.setupKeyboardNavigation(searchInput, suggestionsDropdown);
                this.setupClickOutside(suggestionsDropdown);
                
                // Show clear button if there's a query
                if (this.currentQuery) {
                    this.showClearButton(clearBtn);
                }
                
                console.log('âœ… Unified search system initialized');
            },
            
            setupSearchInput: function(input, dropdown, content) {
                let searchTimeout;
                
                // Input event with debouncing
                input.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    
                    clearTimeout(searchTimeout);
                    
                    // Show/hide clear button
                    const clearBtn = document.getElementById('searchClearBtn');
                    if (query.length > 0) {
                        this.showClearButton(clearBtn);
                    } else {
                        this.hideClearButton(clearBtn);
                    }
                    
                    // Handle suggestions
                    if (query.length >= this.minQueryLength) {
                        searchTimeout = setTimeout(() => {
                            this.loadSuggestions(query, dropdown, content);
                        }, this.debounceDelay);
                    } else if (query.length === 0) {
                        // Show popular terms when empty
                        this.loadPopularTerms(dropdown, content);
                    } else {
                        this.hideSuggestions(dropdown);
                    }
        });
        
                // Focus event
                input.addEventListener('focus', () => {
                    const query = input.value.trim();
                    if (query.length >= this.minQueryLength) {
                        this.loadSuggestions(query, dropdown, content);
                    } else if (query.length === 0) {
                        this.loadPopularTerms(dropdown, content);
                    }
                });
                
                // Blur event (with delay to allow clicking suggestions)
                input.addEventListener('blur', () => {
                    setTimeout(() => {
                        this.hideSuggestions(dropdown);
                    }, 200);
                });
            },
            
            setupClearButton: function(input, clearBtn) {
                if (!clearBtn) return;
                
                clearBtn.addEventListener('click', () => {
                    input.value = '';
                    input.focus();
                    this.hideClearButton(clearBtn);
                    this.hideSuggestions(document.getElementById('searchSuggestionsDropdown'));
                    
                    // Clear URL if we're on search page
                    if (window.location.pathname.includes('/search/')) {
                        window.location.href = '{% url "blog:post_list" %}';
                    }
                });
            },
            
            setupKeyboardNavigation: function(input, dropdown) {
                input.addEventListener('keydown', (e) => {
                    if (!dropdown.classList.contains('show')) return;
                    
                    const suggestions = dropdown.querySelectorAll('.suggestion-item');
                    const current = dropdown.querySelector('.suggestion-item.active');
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (current) {
                            current.classList.remove('active');
                            const next = current.nextElementSibling;
                            if (next) {
                                next.classList.add('active');
                            } else {
                                suggestions[0]?.classList.add('active');
                            }
                        } else {
                            suggestions[0]?.classList.add('active');
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (current) {
                            current.classList.remove('active');
                            const prev = current.previousElementSibling;
                            if (prev) {
                                prev.classList.add('active');
                            } else {
                                suggestions[suggestions.length - 1]?.classList.add('active');
                            }
                        } else {
                            suggestions[suggestions.length - 1]?.classList.add('active');
                        }
                    } else if (e.key === 'Enter') {
                        if (current) {
                            e.preventDefault();
                            current.click();
                        }
                    } else if (e.key === 'Escape') {
                        this.hideSuggestions(dropdown);
                        input.blur();
                    }
                });
            },
            
            setupClickOutside: function(dropdown) {
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.unified-search-form')) {
                        this.hideSuggestions(dropdown);
                    }
                });
            },
            
            loadSuggestions: function(query, dropdown, content) {
                if (!this.enableAjax) return;
                
                // Show loading state
                this.showLoading(content);
                this.showSuggestions(dropdown, query);
                
                // Make AJAX request
                fetch(`${this.endpoint}?q=${encodeURIComponent(query)}&max=${this.maxSuggestions}`)
                    .then(response => response.json())
                    .then(data => {
                        this.displaySuggestions(data.suggestions, content);
                    })
                    .catch(error => {
                        console.error('Search suggestions error:', error);
                        this.showError(content);
                    });
            },
            
            loadPopularTerms: function(dropdown, content) {
                // Show popular terms when no query
                const popularTerms = [
                    { text: 'Machine Learning', type: 'topic', icon: 'fas fa-brain', url: '/blog/search/?q=machine+learning' },
                    { text: 'Python Development', type: 'topic', icon: 'fab fa-python', url: '/blog/search/?q=python' },
                    { text: 'API Design', type: 'topic', icon: 'fas fa-plug', url: '/blog/search/?q=api' },
                    { text: 'Database', type: 'topic', icon: 'fas fa-database', url: '/blog/search/?q=database' },
                    { text: 'Neural Networks', type: 'topic', icon: 'fas fa-project-diagram', url: '/blog/search/?q=neural+networks' }
                ];
                
                this.displaySuggestions(popularTerms, content);
                this.showSuggestions(dropdown, '');
            },
            
            displaySuggestions: function(suggestions, content) {
                if (!suggestions || suggestions.length === 0) {
                    content.innerHTML = '<div class="no-suggestions">No suggestions found</div>';
                    return;
                }
                
                const html = suggestions.map(suggestion => `
                    <div class="suggestion-item" data-url="${suggestion.url}">
                        <div class="suggestion-icon">
                            <i class="${suggestion.icon}"></i>
                        </div>
                        <div class="suggestion-content">
                            <div class="suggestion-text">${suggestion.text}</div>
                            <div class="suggestion-type">${suggestion.type}</div>
                            ${suggestion.description ? `<div class="suggestion-description">${suggestion.description}</div>` : ''}
                        </div>
                        <div class="suggestion-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                `).join('');
                
                content.innerHTML = html;
                
                // Add click handlers
                content.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const url = item.dataset.url;
                        if (url && url !== '#') {
                            window.location.href = url;
                        }
                    });
                });
            },
            
            showSuggestions: function(dropdown, query) {
                if (!dropdown) return;
                
                const queryElement = document.getElementById('suggestionsQuery');
                if (queryElement) {
                    if (query) {
                        queryElement.textContent = `"${query}"`;
                        queryElement.style.display = 'inline';
                    } else {
                        queryElement.style.display = 'none';
                    }
                }
                
                dropdown.style.display = 'block';
                dropdown.offsetHeight; // Force reflow
                dropdown.classList.add('show');
            },
            
            hideSuggestions: function(dropdown) {
                if (!dropdown) return;
                
                dropdown.classList.remove('show');
                setTimeout(() => {
                    dropdown.style.display = 'none';
                }, 200);
            },
            
            showLoading: function(content) {
                content.innerHTML = '<div class="suggestions-loading">Searching...</div>';
            },
            
            showError: function(content) {
                content.innerHTML = '<div class="suggestions-error">Unable to load suggestions</div>';
            },
            
            showClearButton: function(clearBtn) {
                if (clearBtn) {
                    clearBtn.style.display = 'flex';
                }
            },
            
            hideClearButton: function(clearBtn) {
                if (clearBtn) {
                    clearBtn.style.display = 'none';
                }
            }
        };
        
        // Initialize the unified search
        window.datalogInterface.unifiedSearch.init();
        
        // Track search events
        window.datalogInterface.trackEvent('search_interface_loaded', {
            has_query: {{ query|yesno:"true,false" }},
            page_type: 'post_list',
            total_posts: {{ posts|length }}
        });
    }
    
    console.log('âœ… Post list with unified search ready');
});
</script>
{% endblock %}